<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FLUXO Driver Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #6776a3; margin:0; padding:0; color:#001a6a; }
    header { background-color: #001a6a; color: white; padding: 20px; text-align: center; }
    header h1 { margin: 0; font-size: 36px; }
    main { padding: 20px; margin-bottom: 60px; }
    section { margin-bottom: 40px; }
    .flex { display: flex; flex-wrap: wrap; gap: 15px; }
    .card { background: #ffffff; padding: 15px 20px; border-radius: 10px; flex: 1 1 250px; box-shadow: 0 3px 8px rgba(0,0,0,0.1); }
    .card h3, .card h4 { margin-top:0; font-weight: bold; }
    .form-row { display:flex; align-items:center; margin-bottom:10px; gap:10px; flex-wrap: wrap; }
    label { width: 140px; font-weight: bold; }
    input[type="number"], input[type="text"], select { padding:5px; border-radius:5px; border:1px solid #ccc; flex:1; }
    table { width: 55%; border-collapse: collapse; margin-top: 20px; }
    th, td { font-size: 13px; border: 1px solid #ddd; padding: 3px; text-align: center; }
    th { background-color: #afe0e7; }
    .btn { background-color: #28659e; color: white; border: none; padding: 8px 12px; cursor: pointer; border-radius: 5px; }
    .btn:hover { background-color: #8ac4f9; }
    .pagamento-extra { display:none; margin-top:10px; background:#f0fdf0; padding:10px; border-radius:5px; border:1px solid #ccc; }
    footer { position: fixed; bottom: 10px; right: 20px; font-size: 12px; font-weight: bold; color: #333; }
    .whatsapp-btn { background-color: #067000; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; margin-top: 15px; display:inline-block; }
    #resumoContainer { background:#8ac4f9; padding:20px; border-radius:10px; white-space: pre-line; font-size:16px; line-height:1.6; }
    #resumoContainer .valor-liquido { font-size:20px; font-weight:bold; color:#006400; margin-top:10px; }
    #resumoContainer .reserva { margin-top:20px; }
  </style>
</head>
<body>
  <header>
    <h1>FLUXO Driver Dashboard</h1>
  </header>
  <main>

  <!-- ===== META DI√ÅRIA / CAIXA ===== -->
  <section class="flex">
    <div class="card">
      <h3>üéØ Meta Di√°ria</h3>
      <div class="form-row">
        <input type="number" id="metaDiaria" placeholder="Valor" oninput="salvarMeta(); atualizarMeta();">
      </div>
    </div>
    <div class="card">
      <h3>üí∞ Caixa Atual</h3>
      <div id="caixaAtual">0.00</div>
    </div>
    <div class="card">
      <h3>üìà Alcan√ße de Meta</h3>
      <div id="faltaMeta">0.00</div>
    </div>
  </section>

  <!-- ===== DADOS PARA MANUTEN√á√ÉO ===== -->
  <section class="flex">
    <div class="card">
      <h3>‚öô Manuten√ß√£o</h3>
      <div class="form-row"><label>Km Inicial:</label><input type="number" id="kmInicial" oninput="atualizarKmTotal(); salvarCampo('kmInicial')"></div>
      <div class="form-row"><label>Km Final:</label><input type="number" id="kmFinal" oninput="atualizarKmTotal(); salvarCampo('kmFinal')"></div>
      <div class="form-row"><label>Km Total Rodado:</label><span id="kmTotal">0</span></div>
      <div class="form-row"><label>Custo por Km:</label><input type="number" id="custoKm" placeholder="R$/km" oninput="atualizarCustos(); salvarCampo('custoKm')"></div>
      <div class="form-row reserva"><label>Reserva:</label><span id="reservaManutencao">0.00</span></div>
    </div>
  </section>

 <!-- ===== VIAGENS DE APLICATIVO ===== -->
  <section class="card">
    <h3>üöï Viagens de App</h3>
    <div class="form-row">
      <input type="number" id="valorViagemApp" placeholder="Valor R$">
      <select id="descricaoViagemApp">
        <option value="UBER">UBER</option>
        <option value="99">99</option>
        <option value="INDRIVER">INDRIVER</option>
        <option value="OUTROS APP">OUTROS APP</option>
      </select>
      <select id="pagamentoViagemApp" onchange="mostrarPagamentoExtra(this,'extraViagemApp')">
        <option value="dinheiro">Dinheiro</option>
        <option value="pix">PIX</option>
        <option value="cartao">Cart√£o</option>
      </select>
      <button class="btn" onclick="registrar('viagemApp')">Registrar</button>
    </div>
    <div id="extraViagemApp" class="pagamento-extra"></div>
    <table id="tabelaViagemApp"><tr><th>Data/Hora</th><th>Valor L√≠quido</th><th>Descri√ß√£o</th><th>A√ß√µes</th></tr></table>
  </section>

  <!-- ===== Viagem Particular ===== -->
<section class="card">
  <h3>üöñ Viagem Particular/Entradas Extras</h3>
  <div class="form-row">
    <input type="number" id="valorViagemParticular" placeholder="Valor R$">
    <select id="descricaoViagemParticular"><option value="Viagem Particular">Viagem Particular</option></select>
    <select id="pagamentoViagemParticular" onchange="mostrarPagamentoExtra(this,'extraViagemParticular')">
      <option value="dinheiro">Dinheiro</option>
      <option value="pix">PIX</option>
      <option value="cartao">Cart√£o</option>
    </select>
    <button class="btn" onclick="registrar('ViagemParticular')">Registrar</button>
  </div>
  <div id="extraViagemParticular" class="pagamento-extra"></div>
  <table id="tabelaViagemParticular"><tr><th>Data/Hora</th><th>Valor L√≠quido</th><th>Descri√ß√£o</th><th>A√ß√µes</th></tr></table>
</section>

  <!-- ===== ENTRADAS DE EMPRESA ===== -->
  <section class="card">
    <h3>üè¢ Viagem de Empresa</h3>
    <div class="form-row">
      <input type="number" id="valorEntrada" placeholder="Valor R$">
      <select id="descricaoEntrada">
        <option value="PepsiCo">PepsiCo</option>
        <option value="Amcor">Amcor</option>
        <option value="YAZAKI">YAZAKI</option>
        <option value="SuperG√°s">SuperG√°s</option>
      </select>
      <select id="pagamentoEntrada" onchange="mostrarPagamentoExtra(this,'extraEntrada')">
        <option value="dinheiro">Dinheiro</option>
        <option value="pix">PIX</option>
        <option value="cartao">Cart√£o</option>
      </select>
      <button class="btn" onclick="registrar('entrada')">Registrar</button>
    </div>
    <div id="extraEntrada" class="pagamento-extra"></div>
    <table id="tabelaEntrada"><tr><th>Data/Hora</th><th>Valor L√≠quido</th><th>Descri√ß√£o</th><th>A√ß√µes</th></tr></table>
  </section>

  <!-- ===== DESPESAS / SA√çDAS ===== -->
  <section class="card">
    <h3>üí∏ Despesas / Sa√≠das</h3>
    <div class="form-row">
      <input type="number" id="valorDespesa" placeholder="Valor R$">
      <select id="descricaoDespesa">
        <option value="GNV">GNV</option>
        <option value="Gasolina">Gasolina</option>
        <option value="Etanol">Etanol</option>
        <option value="Ped√°gio">Ped√°gio</option>
        <option value="Lava-Jato">Lava-Jato</option>
        <option value="Almo√ßo">Almo√ßo</option>
        <option value="Janta">Janta</option>
        <option value="Caf√©">Caf√©</option>
        <option value="Outros">Outros</option>
      </select>
      <button class="btn" onclick="registrar('despesa')">Registrar</button>
    </div>
    <table id="tabelaDespesa"><tr><th>Data/Hora</th><th>Valor</th><th>Descri√ß√£o</th><th>A√ß√µes</th></tr></table>
  </section>

<!-- RESUMO -->
    <section class="card">
      <h3>üìä Resumo Geral</h3>
      <div class="form-row">
        <label>Filtrar por data:</label>
        <input type="date" id="filtroResumo">
        <button class="btn" onclick="buscarData()">Buscar</button>
      </div>
      <div id="resumoContainer" style="white-space: pre-wrap; margin-top: 10px;"></div>
      <a href="#" id="whatsappLink" class="whatsapp-btn" target="_blank">üì§ Enviar via WhatsApp</a>
      <button class="btn" style="margin-top:10px; background:#444;" onclick="exportarPDF()">üìÑ Exportar em PDF</button>
    </section>
  </main>
  <footer><div id="dataHora"></div></footer>

  <!-- jsPDF CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-unicode@0.1.0/dist/jspdf-unicode.min.js"></script>

<script>
/* ... todo o c√≥digo anterior de registros, salvar, buscarData etc permanece igual ... */

let maquinaConfig = { nome: "TON", credito: 3.58, debito: 1.68 };

function mostrarPagamentoExtra(sel, containerId){
  const cont = document.getElementById(containerId);
  if(sel.value === "cartao"){
    cont.style.display = "block";
    cont.innerHTML = `
      <div class="form-row"><label>Maquineta:</label><input type="text" value="${maquinaConfig.nome}" oninput="maquinaConfig.nome=this.value"></div>
      <div class="form-row"><label>Juros Cr√©dito %:</label><input type="number" step="0.01" value="${maquinaConfig.credito}" oninput="maquinaConfig.credito=this.value"></div>
      <div class="form-row"><label>Juros D√©bito %:</label><input type="number" step="0.01" value="${maquinaConfig.debito}" oninput="maquinaConfig.debito=this.value"></div>
      <div class="form-row"><label>Repassar taxa?</label><select id="${containerId}_repasse"><option value="nao">N√£o (Absorvida)</option><option value="sim">Sim (Repassada)</option></select></div>
      <div class="form-row"><label>Tipo:</label><select id="${containerId}_tipo"><option value="credito">Cr√©dito</option><option value="debito">D√©bito</option></select></div>
    `;
  } else {
    cont.style.display = "none";
    cont.innerHTML = "";
  }
}

function aplicarTaxa(valor, tipo, repasse){
  const taxa = (tipo === "credito" ? maquinaConfig.credito : maquinaConfig.debito) / 100;
  if(repasse === "nao") return { cobrado: valor, liquido: (valor * (1 - taxa)).toFixed(2) };
  else {
    const cobrado = Math.ceil((valor / (1 - taxa)) * 100) / 100;
    return { cobrado: cobrado.toFixed(2), liquido: valor.toFixed(2) };
  }
}

function carregarDados(chave){ return JSON.parse(localStorage.getItem(chave) || "[]"); }
function salvarDados(chave,dados){ localStorage.setItem(chave, JSON.stringify(dados)); }
function salvarCampo(campo){ localStorage.setItem(campo, document.getElementById(campo).value); }
function salvarMeta(){ localStorage.setItem('metaDiaria', document.getElementById('metaDiaria').value); }
function carregarMeta(){
  const m = localStorage.getItem('metaDiaria');
  if(m !== null) document.getElementById('metaDiaria').value = m;
  atualizarMeta();
}

let registros = {
  viagemApp: carregarDados('viagemApp'),
  ViagemParticular: carregarDados('ViagemParticular'),
  entrada: carregarDados('entrada'),
  despesa: carregarDados('despesa')
};

function atualizarDataHora(){
  const now = new Date();
  const dia = now.getDate().toString().padStart(2, '0');
  const mes = ["jan","fev","mar","abr","mai","jun","jul","ago","set","out","nov","dez"][now.getMonth()];
  const hora = now.getHours().toString().padStart(2, '0');
  const min = now.getMinutes().toString().padStart(2, '0');
  document.getElementById('dataHora').textContent = `${dia}/${mes} ${hora}:${min}h`;
}
setInterval(atualizarDataHora, 60000);

function atualizarKmTotal(){
  const ini = parseFloat(document.getElementById('kmInicial').value) || 0;
  const fin = parseFloat(document.getElementById('kmFinal').value) || 0;
  const total = fin - ini;
  document.getElementById('kmTotal').textContent = total.toFixed(1);
  atualizarCustos();
  salvarCampo('kmInicial'); salvarCampo('kmFinal');
}
function atualizarCustos(){
  const km = parseFloat(document.getElementById('kmTotal').textContent) || 0;
  const custo = parseFloat(document.getElementById('custoKm').value) || 0;
  const reserva = (km * custo).toFixed(2);
  document.getElementById('reservaManutencao').textContent = reserva;
}

function registrar(tipo){
  const now = new Date();
  const dataHora = `${now.getDate().toString().padStart(2,'0')}/${["jan","fev","mar","abr","mai","jun","jul","ago","set","out","nov","dez"][now.getMonth()]} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}h`;
  let valor = 0, desc = "", pagamento = "dinheiro", liquido = 0;
  let repasse = "nao", tipoCartao = "credito", containerId = "";

  if(tipo==="viagemApp"){ valor = parseFloat(document.getElementById('valorViagemApp').value)||0; desc = document.getElementById('descricaoViagemApp').value; pagamento = document.getElementById('pagamentoViagemApp').value; containerId = 'extraViagemApp'; }
  else if(tipo==="ViagemParticular"){ valor = parseFloat(document.getElementById('valorViagemParticular').value)||0; desc = document.getElementById('descricaoViagemParticular').value; pagamento = document.getElementById('pagamentoViagemParticular').value; containerId = 'extraViagemParticular'; }
  else if(tipo==="entrada"){ valor = parseFloat(document.getElementById('valorEntrada').value)||0; desc = document.getElementById('descricaoEntrada').value; pagamento = document.getElementById('pagamentoEntrada').value; containerId = 'extraEntrada'; }
  else if(tipo==="despesa"){ valor = parseFloat(document.getElementById('valorDespesa').value)||0; desc = document.getElementById('descricaoDespesa').value; }

  if(pagamento === "cartao"){
    const repEl = document.getElementById(`${containerId}_repasse`);
    const tipoEl = document.getElementById(`${containerId}_tipo`);
    if(repEl) repasse = repEl.value;
    if(tipoEl) tipoCartao = tipoEl.value;
    const taxas = aplicarTaxa(valor, tipoCartao, repasse);
    valor = parseFloat(taxas.cobrado);
    liquido = parseFloat(taxas.liquido);
  } else {
    liquido = valor;
  }

  registros[tipo].push({ data: dataHora, valor: valor.toFixed(2), desc, pagamento, liquido: liquido.toFixed(2) });
  salvarDados(tipo, registros[tipo]);
  atualizarTabela(tipo);
  atualizarCaixa();
}

function atualizarTabela(tipo){
  const tabela = document.getElementById('tabela'+tipo.charAt(0).toUpperCase()+tipo.slice(1));
  tabela.innerHTML = '<tr><th>Data/Hora</th><th>Valor L√≠quido</th><th>Descri√ß√£o</th><th>A√ß√µes</th></tr>';
  registros[tipo].forEach((r,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.data}</td>
      <td>R$ ${r.liquido}<br><small>(${r.pagamento})</small></td>
      <td>${r.desc}</td>
      <td><button class="btn" onclick="excluir('${tipo}',${i})">Excluir</button></td>`;
    tabela.appendChild(tr);
  });
}

function excluir(tipo,index){
  registros[tipo].splice(index,1);
  salvarDados(tipo,registros[tipo]);
  atualizarTabela(tipo);
  atualizarCaixa();
}

function atualizarCaixa(){
  let total = 0;
  ['viagemApp','ViagemParticular','entrada'].forEach(t => registros[t].forEach(r => total += parseFloat(r.liquido)));
  let despesas = 0;
  registros['despesa'].forEach(r => despesas += parseFloat(r.valor));
  const reserva = parseFloat(document.getElementById('reservaManutencao').textContent) || 0;
  document.getElementById('caixaAtual').textContent = (total - despesas).toFixed(2);
  atualizarMeta();
}

function atualizarMeta() {
  const meta = parseFloat(document.getElementById('metaDiaria').value) || 0;
  const caixa = parseFloat(document.getElementById('caixaAtual').textContent) || 0;
  const falta = meta - caixa;
  const faltaEl = document.getElementById('faltaMeta');

  if (falta >= 0) {
    faltaEl.textContent = `- R$ ${falta.toFixed(2)}`;
    faltaEl.style.color = 'red';
  } else {
    faltaEl.textContent = `+ R$ ${Math.abs(falta).toFixed(2)}`;
    faltaEl.style.color = 'green';
  }
}

function montarResumo(){ 
  let resumo = "üìä *Resumo do Dia* üìä\n\n"; 
  let total = 0;

  const tipos = [ 
    { chave: 'viagemApp', titulo: 'Viagens por App' }, 
    { chave: 'ViagemParticular', titulo: 'Viagem Particular/Entradas Extras' }, 
    { chave: 'entrada', titulo: 'Viagens de Empresa' } 
  ];

  tipos.forEach(({chave, titulo}) => { 
    const registrosTipo = registros[chave] || []; 
    if (registrosTipo.length > 0) { 
      resumo += `üü¶ *${titulo}*\n`; 
      registrosTipo.forEach(r => { 
        resumo += `‚Ä¢ ${r.desc} - R$ ${parseFloat(r.liquido).toFixed(2)} (${r.pagamento})\n`; 
        total += parseFloat(r.liquido) || 0; 
      }); 
      resumo += '\n'; 
    } 
  }); 

  resumo += `üßæ *Total Recebido*: R$ ${total.toFixed(2)}\n\n`; 

  let despesas = 0; 
  if (registros.despesa && registros.despesa.length > 0) { 
    resumo += `üî¥ *Despesas Detalhadas*\n`; 
    registros.despesa.forEach(r => { 
      resumo += `‚Ä¢ ${r.desc} - R$ ${parseFloat(r.valor).toFixed(2)}\n`; 
      despesas += parseFloat(r.valor) || 0; 
    }); 
    resumo += '\n'; 
  } 

  resumo += `üí∏ *Total Despesas*: R$ ${despesas.toFixed(2)}\n`; 

  const reserva = parseFloat(document.getElementById('reservaManutencao')?.textContent || 0); 
  resumo += `üîß *Reserva Manuten√ß√£o*: R$ ${reserva.toFixed(2)}\n`; 

  const caixa = (total - despesas).toFixed(2); 
  resumo += `\nüü¢ *Caixa Final*: R$ ${caixa}\n`; 

  const meta = parseFloat(document.getElementById('metaDiaria')?.value || 0); 
  const dif = meta - caixa; 
  if (meta > 0) { 
    resumo += dif > 0 
      ? `üìâ Faltam R$ ${dif.toFixed(2)} para bater a meta.\n`
      : `üìà Ultrapassou a meta em R$ ${Math.abs(dif).toFixed(2)}.\n`; 
  } 

  // Atualiza visualmente no HTML
  const divResumo = document.getElementById('resumoContainer'); 
  if (divResumo) { 
    divResumo.innerText = resumo; 
  }

  return resumo; 
}

    function enviarWhatsApp(){ 
      const texto = montarResumo(); 
      const url = `https://wa.me/?text=${encodeURIComponent(texto)}`; 
      window.open(url, '_blank'); 
    }

     /* ======== FUN√á√ÉO DE EXPORTAR PDF CORRIGIDA ======== */
function exportarPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  const texto = ultimoResumoFiltrado || "Nenhum resumo gerado. Use o bot√£o 'Buscar' para gerar um resumo primeiro.";

  doc.setFont("Helvetica");
  doc.setFontSize(12);

  const linhas = doc.splitTextToSize(texto, 180);
  doc.text(linhas, 10, 20);

  doc.save("Relatorio_Viagens.pdf");
}


function buscarData() {
  const filtro = document.getElementById("filtroResumo").value;
  const resumo = document.getElementById("resumoContainer");
  resumo.innerHTML = '';

  if (!filtro) {
    resumo.textContent = '‚ö†Ô∏è Selecione uma data para gerar o resumo.';
    ultimoResumoFiltrado = '';
    return;
  }

  const [ano, mes, dia] = filtro.split("-");
  const m = ["jan","fev","mar","abr","mai","jun","jul","ago","set","out","nov","dez"][parseInt(mes) - 1];
  const dataFormatada = `${dia}/${m}`;

  const reserva = parseFloat(document.getElementById("reservaManutencao").textContent) || 0;

  let totalApp = 0, totalViagemParticular = 0, totalEntrada = 0, totalDespesa = 0;

  const viagensApp = registros["viagemApp"].filter(r => r.data.startsWith(dataFormatada));
  const viagensParticulares = registros["ViagemParticular"].filter(r => r.data.startsWith(dataFormatada));
  const entradas = registros["entrada"].filter(r => r.data.startsWith(dataFormatada));
  const despesas = registros["despesa"].filter(r => r.data.startsWith(dataFormatada));

  // Construir texto detalhado
  let texto = `Relat√≥rio de Viagens\nDia ${dia}/${m}/${ano}\n\n`;

  texto += `ENTRADAS\n`;

  texto += `\n- Viagens de App:\n`;
  viagensApp.forEach((v, i) => {
    texto += `  ${i + 1}. ${v.desc} - R$ ${parseFloat(v.liquido).toFixed(2)}\n`;
    totalApp += parseFloat(v.liquido);
  });
  texto += `  Total: R$ ${totalApp.toFixed(2)}\n`;

  texto += `\n- Viagens Particulares:\n`;
  viagensParticulares.forEach((v, i) => {
    texto += `  ${i + 1}. ${v.desc} - R$ ${parseFloat(v.liquido).toFixed(2)}\n`;
    totalViagemParticular += parseFloat(v.liquido);
  });
  texto += `  Total: R$ ${totalViagemParticular.toFixed(2)}\n`;

  texto += `\n- Viagens de Empresa:\n`;
  entradas.forEach((e, i) => {
    texto += `  ${i + 1}. ${e.desc} - R$ ${parseFloat(e.liquido).toFixed(2)}\n`;
    totalEntrada += parseFloat(e.liquido);
  });
  texto += `  Total: R$ ${totalEntrada.toFixed(2)}\n`;

  texto += `\nSA√çDAS\n`;

  texto += `\n- Despesas:\n`;
  despesas.forEach((d, i) => {
    texto += `  ${i + 1}. ${d.desc} - R$ ${parseFloat(d.valor).toFixed(2)}\n`;
    totalDespesa += parseFloat(d.valor);
  });
  texto += `  Total: R$ ${totalDespesa.toFixed(2)}\n`;

  texto += `\n- Reserva Manuten√ß√£o: R$ ${reserva.toFixed(2)}\n`;

  const valorLiquido = (totalApp + totalViagemParticular + totalEntrada - totalDespesa - reserva).toFixed(2);
  texto += `\n Valor L√≠quido: R$ ${valorLiquido}`;

  ultimoResumoFiltrado = texto;

  // Atualiza o HTML
  resumo.innerHTML = `<pre>${texto}</pre>`;

  // Atualiza link do WhatsApp
  document.getElementById("whatsappLink").href = `https://wa.me/?text=${encodeURIComponent(ultimoResumoFiltrado)}`;
}

// Carregamento inicial
document.addEventListener('DOMContentLoaded', () => {
  // Carrega meta di√°ria e custos iniciais
  carregarMeta();
  atualizarCustos();
  atualizarKmTotal();

  // Carregar campos persistentes
  ['kmInicial', 'kmFinal', 'custoKm'].forEach(id => {
    const el = document.getElementById(id);
    const val = localStorage.getItem(id);
    if (el && val !== null) el.value = val;
  });

  // Atualizar todas as tabelas
  ['viagemApp', 'ViagemParticular', 'entrada', 'despesa'].forEach(t => atualizarTabela(t));

  atualizarCaixa();
});
</script>

</body>
</html>
