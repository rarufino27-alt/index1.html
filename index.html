<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FLUXO Driver Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #f0f2f5; margin:0; padding:0; color:#001a6a; }
    header { background-color: #001a6a; color: white; padding: 20px; text-align: center; }
    header h1 { margin: 0; font-size: 36px; }
    main { padding: 20px; margin-bottom: 60px; }
    section { margin-bottom: 40px; }
    .flex { display: flex; flex-wrap: wrap; gap: 15px; }
    .card { background: #ffffff; padding: 15px 20px; border-radius: 12px; flex: 1 1 250px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .card h3 { margin-top:0; font-weight: bold; color:#001a6a; }
    .form-row { display:flex; align-items:center; margin-bottom:10px; gap:10px; flex-wrap: wrap; }
    label { width: 140px; font-weight: bold; }
    input[type="number"], input[type="text"], input[type="date"], select { padding:5px; border-radius:5px; border:1px solid #ccc; flex:1; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { font-size: 15px; border: 1px solid #ddd; padding: 6px; text-align: center; }
    th { background-color: #e6f2ff; }
    .btn { background-color: #28659e; color: white; border: none; padding: 8px 12px; cursor: pointer; border-radius: 5px; }
    .btn:hover { background-color: #4a90e2; }
    .pagamento-extra { display:none; margin-top:10px; background:#f0fdf0; padding:10px; border-radius:5px; border:1px solid #ccc; }
    footer { position: fixed; bottom: 10px; right: 20px; font-size: 12px; font-weight: bold; color: #333; }
    .whatsapp-btn { background-color: #067000; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; margin-top: 15px; display:inline-block; }
    
    /* ===== NOVO ESTILO RESUMO ===== */
    .resumo-card { background: #ffffff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); padding: 15px; margin-top: 15px; line-height:1.5; }
    .resumo-card h4 { margin:10px 0 5px; font-size:16px; }
    .resumo-section { padding: 10px; border-radius: 8px; margin-bottom: 10px; }
    .recebimentos { background-color: #e6f2ff; }
    .despesas { background-color: #ffe6e6; }
    .liquido { background-color: #e6ffe6; font-weight:bold; font-size:16px; }
    .resumo-item { display:flex; justify-content:space-between; }
    .resumo-total { font-weight:bold; margin-top:5px; }
    .resumo-final { font-size:18px; color: #006400; font-weight:bold; }
  </style>
</head>
<body>
  <header>
    <h1>FLUXO Driver Dashboard</h1>
  </header>
  <main>

  <!-- ===== META DI√ÅRIA / CAIXA ===== -->
  <section class="flex">
    <div class="card">
      <h3>üéØ Meta Di√°ria</h3>
      <div class="form-row">
        <input type="number" id="metaDiaria" placeholder="Valor" oninput="salvarMeta(); atualizarMeta();">
      </div>
    </div>
    <div class="card">
      <h3>üí∞ Caixa Atual</h3>
      <div id="caixaAtual">0.00</div>
    </div>
    <div class="card">
      <h3>üìà Alcan√ße de Meta</h3>
      <div id="faltaMeta">0.00</div>
    </div>
  </section>

  <!-- ===== DADOS PARA MANUTEN√á√ÉO ===== -->
  <section class="flex">
    <div class="card">
      <h3>‚öô Manuten√ß√£o</h3>
      <div class="form-row"><label>Km Inicial:</label><input type="number" id="kmInicial" oninput="atualizarKmTotal(); salvarCampo('kmInicial')"></div>
      <div class="form-row"><label>Km Final:</label><input type="number" id="kmFinal" oninput="atualizarKmTotal(); salvarCampo('kmFinal')"></div>
      <div class="form-row"><label>Km Total Rodado:</label><span id="kmTotal">0</span></div>
      <div class="form-row"><label>Custo por Km:</label><input type="number" id="custoKm" placeholder="R$/km" oninput="atualizarCustos(); salvarCampo('custoKm')"></div>
      <div class="form-row reserva"><label>Reserva:</label><span id="reservaManutencao">0.00</span></div>
    </div>
  </section>

  <!-- ===== VIAGENS ===== -->
<section class="card">
  <h3>üöï Viagens</h3>
  <div class="form-row">
    <input type="number" id="valorViagemApp" placeholder="Valor R$">
    <select id="descricaoViagemApp">
      <option value="App Uber">App Uber</option>
      <option value="App 99">App 99</option>
      <option value="App Indriver">App Indriver</option>
      <option value="App de entrega">App de entrega</option>
      <option value="Grupo whatsapp">Grupo whatsapp</option>
    </select>
    <select id="pagamentoViagemApp" onchange="mostrarPagamentoExtra(this,'extraViagemApp')">
      <option value="dinheiro">Dinheiro</option>
      <option value="pix">PIX</option>
      <option value="cartao">Cart√£o</option>
    </select>
    <button class="btn" onclick="registrar('viagemApp')">Registrar</button>
  </div>
  <div id="extraViagemApp" class="pagamento-extra"></div>
  <table id="tabelaViagemApp"><tr><th>Data/Hora</th><th>Valor L√≠quido</th><th>Descri√ß√£o</th><th>A√ß√µes</th></tr></table>
</section>

<!-- ===== VIAGEM PARTICULAR / ENTRADAS EXTRA ===== -->
<section class="card">
  <h3>üöñ Viagem Particular/Entradas Extras</h3>
  <div class="form-row">
    <input type="number" id="valorViagemParticular" placeholder="Valor R$">
    <select id="descricaoViagemParticular">
      <option value="Viagem particular">Viagem particular</option>
      <option value="Empr√©stimo cart√£o">Empr√©stimo cart√£o</option>
      <option value="Recebimentos de Fiado">Recebimentos de Fiado</option>
      <option value="Outros recebimentos">Outros recebimentos</option>
    </select>
    <select id="pagamentoViagemParticular" onchange="mostrarPagamentoExtra(this,'extraViagemParticular')">
      <option value="dinheiro">Dinheiro</option>
      <option value="pix">PIX</option>
      <option value="cartao">Cart√£o</option>
    </select>
    <button class="btn" onclick="registrar('ViagemParticular')">Registrar</button>
  </div>
  <div id="extraViagemParticular" class="pagamento-extra"></div>
  <table id="tabelaViagemParticular"><tr><th>Data/Hora</th><th>Valor L√≠quido</th><th>Descri√ß√£o</th><th>A√ß√µes</th></tr></table>
</section>

<!-- ===== ENTRADAS DE EMPRESA ===== -->
<section class="card">
  <h3>üè¢ Viagem de Empresa</h3>
  <div class="form-row">
    <input type="number" id="valorEntrada" placeholder="Valor R$">
    <select id="descricaoEntrada">
      <option value="Viagem extra Sr Ant√¥nio">Viagem extra Sr Ant√¥nio</option>
      <option value="Viagem de rota Sr Ant√¥nio">Viagem de rota Sr Ant√¥nio</option>
      <option value="Viagem de empresa">Viagem de empresa</option>
    </select>
    <select id="pagamentoEntrada" onchange="mostrarPagamentoExtra(this,'extraEntrada')">
      <option value="dinheiro">Dinheiro</option>
      <option value="pix">PIX</option>
      <option value="cartao">Cart√£o</option>
    </select>
    <button class="btn" onclick="registrar('entrada')">Registrar</button>
  </div>
  <div id="extraEntrada" class="pagamento-extra"></div>
  <table id="tabelaEntrada"><tr><th>Data/Hora</th><th>Valor L√≠quido</th><th>Descri√ß√£o</th><th>A√ß√µes</th></tr></table>
</section>

<!-- ===== DESPESAS / SA√çDAS ===== -->
<section class="card">
  <h3>üí∏ Despesas / Sa√≠das</h3>
  <div class="form-row">
    <input type="number" id="valorDespesa" placeholder="Valor R$">
    <select id="descricaoDespesa">
      <option value="Abastecimento GNV">Abastecimento GNV</option>
      <option value="Abastecimento Gasolina">Abastecimento Gasolina</option>
      <option value="Abastecimento Etanol">Abastecimento Etanol</option>
      <option value="Ped√°gio">Ped√°gio</option>
      <option value="Lava-jato">Lava-jato</option>
      <option value="Lanche">Lanche</option>
      <option value="Almo√ßo">Almo√ßo</option>
      <option value="Janta">Janta</option>
      <option value="Caf√©">Caf√©</option>
      <option value="Pagamentos de cart√£o">Pagamentos de cart√£o</option>
      <option value="Pagamentos do carro">Pagamentos do carro</option>
      <option value="Manuten√ß√£o preventiva">Manuten√ß√£o preventiva</option>
      <option value="Manuten√ß√£o corretiva">Manuten√ß√£o corretiva</option>
      <option value="Troca de √≥leo e filtro">Troca de √≥leo e filtro</option>
      <option value="Outros">Outros</option>
    </select>
    <button class="btn" onclick="registrar('despesa')">Registrar</button>
  </div>
  <table id="tabelaDespesa"><tr><th>Data/Hora</th><th>Valor</th><th>Descri√ß√£o</th><th>A√ß√µes</th></tr></table>
</section>

  <!-- ===== RESUMO DO DIA ===== -->
  <section class="card">
    <h3>üìä Resumo do Dia</h3>
    <div id="resumoContainer" class="resumo-card"></div>
    <a href="#" id="whatsappLink" class="whatsapp-btn" target="_blank">üì§ Enviar via WhatsApp</a>
    <button class="btn" style="margin-top:10px; background:#444;" onclick="exportarPDF()">üìÑ Exportar em PDF</button>
  </section>

  <!-- ===== RESUMO POR PER√çODO ===== -->
  <section class="card">
    <h3>üìä Resumo por Per√≠odo</h3>
    <!-- Bot√µes de per√≠odo -->
    <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
      <button class="btn" onclick="filtrarResumo(7)">√öltimos 7 dias</button>
      <button class="btn" onclick="filtrarResumo(15)">√öltimos 15 dias</button>
      <button class="btn" onclick="filtrarResumo(30)">√öltimos 30 dias</button>
      <button class="btn" onclick="mostrarPersonalizado()">Personalizado</button>
    </div>

    <!-- Container para resumo filtrado -->
    <div id="resumoPeriodo" class="resumo-card"></div>

    <!-- Container para filtros personalizados -->
    <div id="personalizadoContainer" style="margin-top:15px; display:none;">
      <label>Data Inicial:</label>
      <input type="date" id="dataInicio">
      <label>Data Final:</label>
      <input type="date" id="dataFim">
      <button class="btn" onclick="filtrarResumoPersonalizado()">Gerar Resumo</button>
    </div>
  </section>

<script>
// Fun√ß√µes de filtragem e resumo detalhado
function filtrarResumo(dias){
  const hoje = new Date();
  const inicio = new Date();
  inicio.setDate(hoje.getDate() - dias + 1);
  gerarResumoPorPeriodo(inicio, hoje);
}

function mostrarPersonalizado(){
  document.getElementById("personalizadoContainer").style.display = "block";
  document.getElementById("resumoPeriodo").innerHTML = "";
}

function filtrarResumoPersonalizado(){
  const inicioStr = document.getElementById("dataInicio").value;
  const fimStr = document.getElementById("dataFim").value;
  if(!inicioStr || !fimStr){ alert("Selecione as duas datas!"); return; }

  const inicio = new Date(inicioStr);
  const fim = new Date(fimStr);
  const diff = (fim - inicio)/(1000*60*60*24);
  if(diff<0 || diff>90){ alert("O per√≠odo deve ter at√© 90 dias corridos."); return; }

  gerarResumoPorPeriodo(inicio, fim);
}

function gerarResumoPorPeriodo(inicio,fim){
  const resumoDiv = document.getElementById("resumoPeriodo");
  resumoDiv.innerHTML = "";

  const formas = ["dinheiro","pix","cartao"];
  let totalRecebimentos = {dinheiro:0, pix:0, cartao:0}, totalDespesas = {dinheiro:0, pix:0, cartao:0};

  // Recebimentos
  const tipos = ["viagemApp","ViagemParticular","entrada"];
  const secReceb = document.createElement("div");
  secReceb.className = "resumo-section recebimentos";
  secReceb.innerHTML = `<h4>Recebimentos</h4>`;

  tipos.forEach(tipo=>{
    registros[tipo].forEach(r=>{
      const [dia, mesTxt] = r.data.split(" ")[0].split("/");
      const mesNum = ["jan","fev","mar","abr","mai","jun","jul","ago","set","out","nov","dez"].indexOf(mesTxt);
      const dataRegistro = new Date(new Date().getFullYear(), mesNum, parseInt(dia));
      if(dataRegistro>=inicio && dataRegistro<=fim){
        totalRecebimentos[r.pagamento] += parseFloat(r.liquido);
      }
    });
  });

  formas.forEach(f=>{
    const item = document.createElement("div");
    item.className = "resumo-item";
    item.innerHTML = `<span>${f.charAt(0).toUpperCase()+f.slice(1)}:</span><span>R$ ${totalRecebimentos[f].toFixed(2)}</span>`;
    secReceb.appendChild(item);
  });
  const totalRec = formas.reduce((a,f)=>a+totalRecebimentos[f],0);
  const totalEl = document.createElement("div"); totalEl.className="resumo-total"; totalEl.innerHTML=`Total Recebido: R$ ${totalRec.toFixed(2)}`;
  secReceb.appendChild(totalEl);
  resumoDiv.appendChild(secReceb);

// Despesas detalhadas
const secDesp = document.createElement("div");
secDesp.className = "resumo-section despesas";
secDesp.innerHTML = `<h4>Despesas</h4>`;

let totalDes = 0;

registros["despesa"].forEach(r => {
  const [dia, mesTxt] = r.data.split(" ")[0].split("/");
  const mesNum = ["jan","fev","mar","abr","mai","jun","jul","ago","set","out","nov","dez"].indexOf(mesTxt);
  const dataRegistro = new Date(new Date().getFullYear(), mesNum, parseInt(dia));
  if (dataRegistro >= inicio && dataRegistro <= fim) {
    const item = document.createElement("div");
    item.className = "resumo-item";
    item.innerHTML = `<span>${r.desc}</span><span>R$ ${parseFloat(r.valor).toFixed(2)}</span>`;
    secDesp.appendChild(item);
    totalDes += parseFloat(r.valor);
  }
});

const totalDesEl = document.createElement("div");
totalDesEl.className = "resumo-total";
totalDesEl.innerHTML = `Total Despesas: R$ ${totalDes.toFixed(2)}`;
secDesp.appendChild(totalDesEl);
resumoDiv.appendChild(secDesp);

  // Caixa final
  const secFinal = document.createElement("div");
  secFinal.className="resumo-section liquido resumo-final";
  secFinal.innerHTML=`üí∞ Caixa Final: R$ ${(totalRec-totalDes).toFixed(2)}`;
  resumoDiv.appendChild(secFinal);
}
</script>

</main>
<footer><div id="dataHora"></div></footer>
<script>
function atualizarDataHora(){
  const now = new Date();
  const dia = now.getDate().toString().padStart(2,'0');
  const mes = ["jan","fev","mar","abr","mai","jun","jul","ago","set","out","nov","dez"][now.getMonth()];
  const hora = now.getHours().toString().padStart(2,'0');
  const min = now.getMinutes().toString().padStart(2,'0');
  document.getElementById('dataHora').textContent = `${dia}/${mes} ${hora}:${min}h`;
}
setInterval(atualizarDataHora,60000);
atualizarDataHora();
</script>

  </main>
  <footer><div id="dataHora"></div></footer>

  <!-- jsPDF CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-unicode@0.1.0/dist/jspdf-unicode.min.js"></script>

<script>
/* ... todo o c√≥digo anterior de registros, salvar, buscarData etc permanece igual ... */

let maquinaConfig = { nome: "TON", credito: 3.58, debito: 1.68 };

function mostrarPagamentoExtra(sel, containerId){
  const cont = document.getElementById(containerId);
  if(sel.value === "cartao"){
    cont.style.display = "block";
    cont.innerHTML = `
      <div class="form-row"><label>Maquineta:</label><input type="text" value="${maquinaConfig.nome}" oninput="maquinaConfig.nome=this.value"></div>
      <div class="form-row"><label>Juros Cr√©dito %:</label><input type="number" step="0.01" value="${maquinaConfig.credito}" oninput="maquinaConfig.credito=this.value"></div>
      <div class="form-row"><label>Juros D√©bito %:</label><input type="number" step="0.01" value="${maquinaConfig.debito}" oninput="maquinaConfig.debito=this.value"></div>
      <div class="form-row"><label>Repassar taxa?</label><select id="${containerId}_repasse"><option value="nao">N√£o (Absorvida)</option><option value="sim">Sim (Repassada)</option></select></div>
      <div class="form-row"><label>Tipo:</label><select id="${containerId}_tipo"><option value="credito">Cr√©dito</option><option value="debito">D√©bito</option></select></div>
    `;
  } else {
    cont.style.display = "none";
    cont.innerHTML = "";
  }
}

function aplicarTaxa(valor, tipo, repasse){
  const taxa = (tipo === "credito" ? maquinaConfig.credito : maquinaConfig.debito) / 100;
  if(repasse === "nao") return { cobrado: valor, liquido: (valor * (1 - taxa)).toFixed(2) };
  else {
    const cobrado = Math.ceil((valor / (1 - taxa)) * 100) / 100;
    return { cobrado: cobrado.toFixed(2), liquido: valor.toFixed(2) };
  }
}

function carregarDados(chave){ return JSON.parse(localStorage.getItem(chave) || "[]"); }
function salvarDados(chave,dados){ localStorage.setItem(chave, JSON.stringify(dados)); }
function salvarCampo(campo){ localStorage.setItem(campo, document.getElementById(campo).value); }
function salvarMeta(){ localStorage.setItem('metaDiaria', document.getElementById('metaDiaria').value); }
function carregarMeta(){
  const m = localStorage.getItem('metaDiaria');
  if(m !== null) document.getElementById('metaDiaria').value = m;
  atualizarMeta();
}

let registros = {
  viagemApp: carregarDados('viagemApp'),
  ViagemParticular: carregarDados('ViagemParticular'),
  entrada: carregarDados('entrada'),
  despesa: carregarDados('despesa')
};

function atualizarDataHora(){
  const now = new Date();
  const dia = now.getDate().toString().padStart(2, '0');
  const mes = ["jan","fev","mar","abr","mai","jun","jul","ago","set","out","nov","dez"][now.getMonth()];
  const hora = now.getHours().toString().padStart(2, '0');
  const min = now.getMinutes().toString().padStart(2, '0');
  document.getElementById('dataHora').textContent = `${dia}/${mes} ${hora}:${min}h`;
}
setInterval(atualizarDataHora, 60000);

function atualizarKmTotal(){
  const ini = parseFloat(document.getElementById('kmInicial').value) || 0;
  const fin = parseFloat(document.getElementById('kmFinal').value) || 0;
  const total = fin - ini;
  document.getElementById('kmTotal').textContent = total.toFixed(1);
  atualizarCustos();
  salvarCampo('kmInicial'); salvarCampo('kmFinal');
}
function atualizarCustos(){
  const km = parseFloat(document.getElementById('kmTotal').textContent) || 0;
  const custo = parseFloat(document.getElementById('custoKm').value) || 0;
  const reserva = (km * custo).toFixed(2);
  document.getElementById('reservaManutencao').textContent = reserva;
}

function registrar(tipo){
  const now = new Date();
  const dataHora = `${now.getDate().toString().padStart(2,'0')}/${["jan","fev","mar","abr","mai","jun","jul","ago","set","out","nov","dez"][now.getMonth()]} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}h`;
  let valor = 0, desc = "", pagamento = "dinheiro", liquido = 0;
  let repasse = "nao", tipoCartao = "credito", containerId = "";

  if(tipo==="viagemApp"){ valor = parseFloat(document.getElementById('valorViagemApp').value)||0; desc = document.getElementById('descricaoViagemApp').value; pagamento = document.getElementById('pagamentoViagemApp').value; containerId = 'extraViagemApp'; }
  else if(tipo==="ViagemParticular"){ valor = parseFloat(document.getElementById('valorViagemParticular').value)||0; desc = document.getElementById('descricaoViagemParticular').value; pagamento = document.getElementById('pagamentoViagemParticular').value; containerId = 'extraViagemParticular'; }
  else if(tipo==="entrada"){ valor = parseFloat(document.getElementById('valorEntrada').value)||0; desc = document.getElementById('descricaoEntrada').value; pagamento = document.getElementById('pagamentoEntrada').value; containerId = 'extraEntrada'; }
  else if(tipo==="despesa"){ valor = parseFloat(document.getElementById('valorDespesa').value)||0; desc = document.getElementById('descricaoDespesa').value; }

  if(pagamento === "cartao"){
    const repEl = document.getElementById(`${containerId}_repasse`);
    const tipoEl = document.getElementById(`${containerId}_tipo`);
    if(repEl) repasse = repEl.value;
    if(tipoEl) tipoCartao = tipoEl.value;
    const taxas = aplicarTaxa(valor, tipoCartao, repasse);
    valor = parseFloat(taxas.cobrado);
    liquido = parseFloat(taxas.liquido);
  } else {
    liquido = valor;
  }

  registros[tipo].push({ data: dataHora, valor: valor.toFixed(2), desc, pagamento, liquido: liquido.toFixed(2) });
  salvarDados(tipo, registros[tipo]);
  atualizarTabela(tipo);
  atualizarCaixa();
  montarResumo(); // ‚úÖ Atualiza automaticamente o resumo do dia
}

function atualizarTabela(tipo){
  const tabela = document.getElementById('tabela'+tipo.charAt(0).toUpperCase()+tipo.slice(1));
  tabela.innerHTML = '<tr><th>Data/Hora</th><th>Valor L√≠quido</th><th>Descri√ß√£o</th><th>A√ß√µes</th></tr>';
  registros[tipo].forEach((r,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.data}</td>
      <td>R$ ${r.liquido}<br><small>(${r.pagamento})</small></td>
      <td>${r.desc}</td>
      <td><button class="btn" onclick="excluir('${tipo}',${i})">Excluir</button></td>`;
    tabela.appendChild(tr);
  });
}

function excluir(tipo,index){
  registros[tipo].splice(index,1);
  salvarDados(tipo,registros[tipo]);
  atualizarTabela(tipo);
  atualizarCaixa();
}

function atualizarCaixa(){
  let total = 0;
  ['viagemApp','ViagemParticular','entrada'].forEach(t => registros[t].forEach(r => total += parseFloat(r.liquido)));
  let despesas = 0;
  registros['despesa'].forEach(r => despesas += parseFloat(r.valor));
  const reserva = parseFloat(document.getElementById('reservaManutencao').textContent) || 0;
  document.getElementById('caixaAtual').textContent = (total - despesas).toFixed(2);
  atualizarMeta();
}

function atualizarMeta() {
  const meta = parseFloat(document.getElementById('metaDiaria').value) || 0;
  const caixa = parseFloat(document.getElementById('caixaAtual').textContent) || 0;
  const falta = meta - caixa;
  const faltaEl = document.getElementById('faltaMeta');

  if (falta >= 0) {
    faltaEl.textContent = `- R$ ${falta.toFixed(2)}`;
    faltaEl.style.color = 'red';
  } else {
    faltaEl.textContent = `+ R$ ${Math.abs(falta).toFixed(2)}`;
    faltaEl.style.color = 'green';
  }
}

function montarResumo(){ 
  const agora = new Date();
  const diaHoje = agora.getDate().toString().padStart(2,'0');
  const mesHoje = ["jan","fev","mar","abr","mai","jun","jul","ago","set","out","nov","dez"][agora.getMonth()];
  const anoHoje = agora.getFullYear();

  const inicioDia = new Date(anoHoje, agora.getMonth(), agora.getDate(), 0, 0, 0);
  const fimDia = new Date(anoHoje, agora.getMonth(), agora.getDate(), 23, 59, 59);

  let resumo = "üìä *Resumo do Dia* üìä\n\n"; 

  const tipos = [ 
    { chave: 'viagemApp', titulo: 'Viagens por App' }, 
    { chave: 'ViagemParticular', titulo: 'Viagem Particular/Entradas Extras' }, 
    { chave: 'entrada', titulo: 'Viagens de Empresa' } 
  ];

  let totalRecebido = 0;

  tipos.forEach(({chave, titulo}) => { 
    const registrosTipo = registros[chave] || []; 
    const registrosDoDia = registrosTipo.filter(r => {
      const [dia, mesTxt] = r.data.split(" ")[0].split("/");
      const hora = r.data.split(" ")[1]; // hh:mmh
      const [hh, mm] = hora.replace("h","").split(":").map(n => parseInt(n));
      const mesNum = ["jan","fev","mar","abr","mai","jun","jul","ago","set","out","nov","dez"].indexOf(mesTxt);
      const dataRegistro = new Date(anoHoje, mesNum, parseInt(dia), hh, mm);
      return dataRegistro >= inicioDia && dataRegistro <= fimDia;
    });

    if(registrosDoDia.length > 0){ 
      resumo += `üü¶ *${titulo}*\n`; 
      registrosDoDia.forEach(r => { 
        resumo += `‚Ä¢ ${r.desc} - R$ ${parseFloat(r.liquido).toFixed(2)}\n`; 
        totalRecebido += parseFloat(r.liquido) || 0; 
      }); 
      resumo += '\n'; 
    } 
  }); 

  resumo += `üßæ *Total Recebido*: R$ ${totalRecebido.toFixed(2)}\n\n`; 

  // Despesas do dia
  let totalDespesas = 0;
  const despesasDoDia = registros["despesa"].filter(r => {
    const [dia, mesTxt] = r.data.split(" ")[0].split("/");
    const hora = r.data.split(" ")[1];
    const [hh, mm] = hora.replace("h","").split(":").map(n => parseInt(n));
    const mesNum = ["jan","fev","mar","abr","mai","jun","jul","ago","set","out","nov","dez"].indexOf(mesTxt);
    const dataRegistro = new Date(anoHoje, mesNum, parseInt(dia), hh, mm);
    return dataRegistro >= inicioDia && dataRegistro <= fimDia;
  });

  if(despesasDoDia.length > 0){
    resumo += `üî¥ *Despesas Detalhadas*\n`;
    despesasDoDia.forEach(r => {
      resumo += `‚Ä¢ ${r.desc} - R$ ${parseFloat(r.valor).toFixed(2)}\n`;
      totalDespesas += parseFloat(r.valor);
    });
    resumo += `\nüí∏ *Total Despesas*: R$ ${totalDespesas.toFixed(2)}\n`;
  }

  const reserva = parseFloat(document.getElementById('reservaManutencao')?.textContent || 0);
  resumo += `üîß *Reserva Manuten√ß√£o*: R$ ${reserva.toFixed(2)}\n`;

  const caixa = (totalRecebido - totalDespesas - reserva).toFixed(2);
  resumo += `\nüü¢ *Valor L√≠quido do Dia*: R$ ${caixa}\n`;

  // Atualiza visualmente no HTML
  const divResumo = document.getElementById('resumoContainer'); 
  if (divResumo) { 
    divResumo.innerText = resumo; 
  }

  return resumo; 
}

    function enviarWhatsApp(){ 
      const texto = montarResumo(); 
      const url = `https://wa.me/?text=${encodeURIComponent(texto)}`; 
      window.open(url, '_blank'); 
    }

     /* ======== FUN√á√ÉO DE EXPORTAR PDF CORRIGIDA ======== */
function exportarPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  const texto = ultimoResumoFiltrado || "Nenhum resumo gerado. Use o bot√£o 'Buscar' para gerar um resumo primeiro.";

  doc.setFont("Helvetica");
  doc.setFontSize(12);

  const linhas = doc.splitTextToSize(texto, 180);
  doc.text(linhas, 10, 20);

  doc.save("Relatorio_Viagens.pdf");
}


function buscarData() {
  const filtro = document.getElementById("filtroResumo").value;
  const resumo = document.getElementById("resumoContainer");
  resumo.innerHTML = '';

  if (!filtro) {
    resumo.textContent = '‚ö†Ô∏è Selecione uma data para gerar o resumo.';
    ultimoResumoFiltrado = '';
    return;
  }

  const [ano, mes, dia] = filtro.split("-");
  const m = ["jan","fev","mar","abr","mai","jun","jul","ago","set","out","nov","dez"][parseInt(mes) - 1];
  const dataFormatada = `${dia}/${m}`;

  const reserva = parseFloat(document.getElementById("reservaManutencao").textContent) || 0;

  let totalApp = 0, totalViagemParticular = 0, totalEntrada = 0, totalDespesa = 0;

  const viagensApp = registros["viagemApp"].filter(r => r.data.startsWith(dataFormatada));
  const viagensParticulares = registros["ViagemParticular"].filter(r => r.data.startsWith(dataFormatada));
  const entradas = registros["entrada"].filter(r => r.data.startsWith(dataFormatada));
  const despesas = registros["despesa"].filter(r => r.data.startsWith(dataFormatada));

  // Construir texto detalhado
  let texto = `Relat√≥rio de Viagens\nDia ${dia}/${m}/${ano}\n\n`;

  texto += `ENTRADAS\n`;

  texto += `\n- Viagens de App:\n`;
  viagensApp.forEach((v, i) => {
    texto += `  ${i + 1}. ${v.desc} - R$ ${parseFloat(v.liquido).toFixed(2)}\n`;
    totalApp += parseFloat(v.liquido);
  });
  texto += `  Total: R$ ${totalApp.toFixed(2)}\n`;

  texto += `\n- Viagens Particulares:\n`;
  viagensParticulares.forEach((v, i) => {
    texto += `  ${i + 1}. ${v.desc} - R$ ${parseFloat(v.liquido).toFixed(2)}\n`;
    totalViagemParticular += parseFloat(v.liquido);
  });
  texto += `  Total: R$ ${totalViagemParticular.toFixed(2)}\n`;

  texto += `\n- Viagens de Empresa:\n`;
  entradas.forEach((e, i) => {
    texto += `  ${i + 1}. ${e.desc} - R$ ${parseFloat(e.liquido).toFixed(2)}\n`;
    totalEntrada += parseFloat(e.liquido);
  });
  texto += `  Total: R$ ${totalEntrada.toFixed(2)}\n`;

  texto += `\nSA√çDAS\n`;

  texto += `\n- Despesas:\n`;
  despesas.forEach((d, i) => {
    texto += `  ${i + 1}. ${d.desc} - R$ ${parseFloat(d.valor).toFixed(2)}\n`;
    totalDespesa += parseFloat(d.valor);
  });
  texto += `  Total: R$ ${totalDespesa.toFixed(2)}\n`;

  texto += `\n- Reserva Manuten√ß√£o: R$ ${reserva.toFixed(2)}\n`;

  const valorLiquido = (totalApp + totalViagemParticular + totalEntrada - totalDespesa - reserva).toFixed(2);
  texto += `\n Valor L√≠quido: R$ ${valorLiquido}`;

  ultimoResumoFiltrado = texto;

  // Atualiza o HTML
  resumo.innerHTML = `<pre>${texto}</pre>`;

  // Atualiza link do WhatsApp
  document.getElementById("whatsappLink").href = `https://wa.me/?text=${encodeURIComponent(ultimoResumoFiltrado)}`;
}

// Carregamento inicial
document.addEventListener('DOMContentLoaded', () => {
  // Carrega meta di√°ria e custos iniciais
  carregarMeta();
  atualizarCustos();
  atualizarKmTotal();

  // Carregar campos persistentes
  ['kmInicial', 'kmFinal', 'custoKm'].forEach(id => {
    const el = document.getElementById(id);
    const val = localStorage.getItem(id);
    if (el && val !== null) el.value = val;
  });

  // Atualizar todas as tabelas
  ['viagemApp', 'ViagemParticular', 'entrada', 'despesa'].forEach(t => atualizarTabela(t));

  atualizarCaixa();

  montarResumo(); // ‚úÖ Gera resumo inicial ao carregar a p√°gina
});
</script>

</body>
</html>
