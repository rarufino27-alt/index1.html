<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Destino – RF Driver</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="./theme/theme.css">
<link rel="stylesheet" href="./theme/layout.css">
<link rel="stylesheet" href="./theme/components.css">
</head>

<body>

<!-- HEADER -->
<div class="card highlight" style="text-align:center">
  <h2>Selecionar Destino</h2>
  <p class="muted">Escolha o destino da corrida</p>
</div>

<!-- SELETOR COM BUSCA -->
<div class="card">
  <label>Destino</label>

  <div class="select-box" id="destinoSelect">
    <div class="select-display" id="destinoDisplay">
      Selecione o destino
    </div>

    <div class="select-panel" id="destinoPanel">
      <input
        type="text"
        id="destinoBusca"
        placeholder="Buscar destino..."
      >
      <div class="select-options" id="destinoOptions"></div>
    </div>
  </div>
</div>

<!-- AÇÃO -->
<div class="card highlight" style="text-align:center">
  <button class="btn btn-primary" id="btnContinuar" disabled>
    Continuar para resumo →
  </button>
</div>

<script src="core/global.js"></script>
<script src="core/datamanager.js"></script>

<script>
const origem = App.get("origem");
if (!origem) App.go("index.html");

const display = document.getElementById("destinoDisplay");
const panel = document.getElementById("destinoPanel");
const busca = document.getElementById("destinoBusca");
const options = document.getElementById("destinoOptions");
const btn = document.getElementById("btnContinuar");

let destinos = [];

display.onclick = () => {
  panel.style.display = panel.style.display === "block" ? "none" : "block";
  busca.focus();
};

async function carregarDestinos(){
  await DataManager.carregar();
  destinos = DataManager.listarDestinos(origem);
  renderOptions(destinos);
}

function renderOptions(lista){
  options.innerHTML = "";
  lista.forEach(nome => {
    const valor = DataManager.buscarValor(origem, nome);
    const div = document.createElement("div");
    div.textContent = nome;

    div.onclick = () => {
      display.textContent = nome;
      App.set("destino", nome);
      App.set("valorBase", valor);
      panel.style.display = "none";
      btn.disabled = false;
    };

    options.appendChild(div);
  });
}

busca.addEventListener("input", () => {
  const termo = busca.value.toLowerCase();
  const filtrados = destinos.filter(d =>
    d.toLowerCase().includes(termo)
  );
  renderOptions(filtrados);
});

document.addEventListener("click", e => {
  if (!document.getElementById("destinoSelect").contains(e.target)) {
    panel.style.display = "none";
  }
});

btn.onclick = () => App.go("resumo.html");

carregarDestinos();
</script>

</body>
</html>